<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQOS Expert Saga</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #0a0a0a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    class IQOSGame extends Phaser.Scene {
        constructor() { super('IQOSGame'); }

        init() {
            // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð»Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
            this.money = parseInt(localStorage.getItem('iqos_money')) || 0;
            this.xp = parseInt(localStorage.getItem('iqos_xp')) || 0;
            this.level = Math.floor(this.xp / 500) + 1;
        }

        create() {
            const { width, height } = this.scale;

            // Ð ÐµÐ½Ð´ÐµÑ€ Ñ„Ð¾Ð½Ð°
            const bg = this.add.graphics();
            bg.fillGradientStyle(0x1a1a1a, 0x1a1a1a, 0x050505, 0x050505, 1);
            bg.fillRect(0, 0, width, height);

            // Ð’ÐµÑ€Ñ…Ð½ÑÑ Ð¿Ð°Ð½ÐµÐ»ÑŒ (Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð¸ Ð”ÐµÐ½ÑŒÐ³Ð¸)
            this.uiPanel = this.add.graphics().fillStyle(0x000000, 0.7).fillRect(0, 0, width, 100);
            this.moneyText = this.add.text(20, 20, `ðŸ’µ $${this.money}`, { fontSize: '22px', fill: '#00f2ff', fontWeight: 'bold' });
            this.levelText = this.add.text(20, 55, `â­ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ: ${this.level} (XP: ${this.xp})`, { fontSize: '16px', fill: '#ffffff' });

            // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            this.createRandomClient();
        }

        createRandomClient() {
            const { width, height } = this.scale;
            const missionTypes = ['clean', 'diag', 'sale'];
            const type = missionTypes[Math.floor(Math.random() * missionTypes.length)];

            this.currentMission = this.getMissionData(type);

            // Ð’Ð¸Ð·ÑƒÐ°Ð» ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            this.clientContainer = this.add.container(width/2, height * 0.4);
            const body = this.add.ellipse(0, 100, 130, 200, 0x222222).setStrokeStyle(2, 0x444444);
            const head = this.add.circle(0, 0, 40, 0x333333);
            this.clientContainer.add([body, head]);

            // ÐžÐ±Ð»Ð°Ñ‡ÐºÐ¾ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°
            this.dialogBox = this.add.container(width/2, height * 0.7);
            const rect = this.add.rectangle(0, 0, width - 40, 150, 0xffffff, 0.05).setStrokeStyle(1, 0x00f2ff, 0.3);
            const msg = this.add.text(0, -30, this.currentMission.text, { 
                fontSize: '18px', fill: '#fff', align: 'center', wordWrap: { width: width - 80 } 
            }).setOrigin(0.5);

            // ÐšÐ½Ð¾Ð¿ÐºÐ° Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ
            const btn = this.add.rectangle(0, 40, 220, 50, 0x00f2ff).setInteractive();
            const btnTxt = this.add.text(0, 40, "ÐÐÐ§ÐÐ¢Ð¬", { color: '#000', fontWeight: 'bold' }).setOrigin(0.5);
            
            this.dialogBox.add([rect, msg, btn, btnTxt]);

            btn.on('pointerdown', () => this.startMission(type));
        }

        getMissionData(type) {
            const data = {
                clean: { text: "ÐœÐ¾Ð¹ Ð°Ð¹ÐºÐ¾Ñ Ð·Ð°ÑÐ¾Ñ€Ð¸Ð»ÑÑ, Ð²ÐºÑƒÑ ÑÐ¾Ð²ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð¿Ð°Ð». ÐŸÐ¾Ñ‡Ð¸ÑÑ‚Ð¸ÑˆÑŒ?", reward: 50, xp: 100 },
                diag: { text: "Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¼Ð¸Ð³Ð°ÐµÑ‚ ÐºÑ€Ð°ÑÐ½Ñ‹Ð¼ Ð¸ Ð½Ðµ Ð·Ð°Ñ€ÑÐ¶Ð°ÐµÑ‚ÑÑ. Ð’ Ñ‡ÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°?", reward: 80, xp: 150 },
                sale: { text: "Ð¥Ð¾Ñ‡Ñƒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð¸Ð»ÑŒ. Ð•ÑÑ‚ÑŒ ÐºÐ»Ð°ÑÑÐ½Ñ‹Ðµ ÐºÐ¾Ð»Ð¿Ð°Ñ‡ÐºÐ¸?", reward: 120, xp: 200 }
            };
            return data[type];
        }

        startMission(type) {
            tg.HapticFeedback.impactOccurred('medium');
            this.dialogBox.setVisible(false);
            
            if (type === 'clean') this.miniGameClean();
            if (type === 'diag') this.miniGameDiag();
            if (type === 'sale') this.miniGameSale();
        }

        // --- ÐœÐ˜ÐÐ˜-Ð˜Ð“Ð Ð: Ð§Ð˜Ð¡Ð¢ÐšÐ (Ð¢Ð°Ð¿Ñ‹) ---
        miniGameClean() {
            const { width, height } = this.scale;
            const item = this.add.circle(width/2, height/2, 60, 0xffffff, 0.1).setStrokeStyle(2, 0x00f2ff);
            const dirt = this.add.circle(width/2, height/2, 20, 0x443322);
            
            let clicks = 0;
            dirt.setInteractive().on('pointerdown', () => {
                clicks++;
                dirt.alpha -= 0.15;
                tg.HapticFeedback.selectionChanged();
                if (clicks >= 7) {
                    item.destroy(); dirt.destroy();
                    this.completeMission();
                }
            });
        }

        // --- ÐœÐ˜ÐÐ˜-Ð˜Ð“Ð Ð: Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ (Ð£Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ) ---
        miniGameDiag() {
            const { width, height } = this.scale;
            const barBg = this.add.rectangle(width/2, height/2, 200, 20, 0x333333);
            const barFill = this.add.rectangle(width/2 - 100, height/2, 0, 20, 0x00f2ff).setOrigin(0, 0.5);
            
            this.add.text(width/2, height/2 - 40, "Ð—ÐÐ–ÐœÐ˜ Ð”Ð›Ð¯ Ð¡ÐšÐÐÐ•Ð ÐžÐ’ÐÐÐ˜Ð¯", { fontSize: '14px', fill: '#00f2ff' }).setOrigin(0.5);

            this.input.on('pointerdown', () => this.isScanning = true);
            this.input.on('pointerup', () => this.isScanning = false);

            this.scanTimer = this.time.addEvent({
                delay: 50,
                callback: () => {
                    if (this.isScanning && barFill.width < 200) {
                        barFill.width += 4;
                        tg.HapticFeedback.selectionChanged();
                        if (barFill.width >= 200) {
                            this.scanTimer.remove();
                            this.completeMission();
                        }
                    }
                },
                loop: true
            });
        }

        // --- ÐœÐ˜ÐÐ˜-Ð˜Ð“Ð Ð: ÐŸÐ ÐžÐ”ÐÐ–Ð (Ð’Ñ‹Ð±Ð¾Ñ€) ---
        miniGameSale() {
            const { width, height } = this.scale;
            const options = ["Ð¡Ð¸Ð½Ð¸Ð¹ ÐºÐ¾Ð»Ð¿Ð°Ñ‡Ð¾Ðº", "Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ Ñ‡ÐµÑ…Ð¾Ð»"];
            
            options.forEach((opt, i) => {
                const b = this.add.rectangle(width/2, height/2 - 50 + (i * 80), 250, 60, 0x333333).setInteractive();
                const t = this.add.text(width/2, height/2 - 50 + (i * 80), opt, { fill: '#00f2ff' }).setOrigin(0.5);
                
                b.on('pointerdown', () => {
                    this.completeMission();
                });
            });
        }

        completeMission() {
            this.money += this.currentMission.reward;
            this.xp += this.currentMission.xp;
            
            localStorage.setItem('iqos_money', this.money);
            localStorage.setItem('iqos_xp', this.xp);

            tg.HapticFeedback.notificationOccurred('success');
            
            // Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± ÑƒÑÐ¿ÐµÑ…Ðµ
            const { width, height } = this.scale;
            const winText = this.add.text(width/2, height/2, `Ð£Ð¡ÐŸÐ•Ð¥!\n+$${this.currentMission.reward}\n+${this.currentMission.xp} XP`, {
                fontSize: '32px', color: '#00f2ff', align: 'center', fontWeight: 'bold'
            }).setOrigin(0.5);

            this.time.delayedCall(2000, () => {
                location.reload(); 
            });
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        scene: IQOSGame,
        backgroundColor: '#0a0a0a'
    };
    new Phaser.Game(config);
</script>
</body>
</html>

