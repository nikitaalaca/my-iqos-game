<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQOS Smash Expert</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; }
    </style>
</head>
<body>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    class WhackGame extends Phaser.Scene {
        constructor() { super('WhackGame'); }

        init() {
            this.score = 0;
            this.timeLeft = 30; // Игра длится 30 секунд
            this.isGameOver = false;
        }

        create() {
            const { width, height } = this.scale;

            // Фон (Стильный темный стол)
            const bg = this.add.graphics();
            bg.fillGradientStyle(0x0f0f0f, 0x0f0f0f, 0x1a1a1a, 0x1a1a1a, 1);
            bg.fillRect(0, 0, width, height);

            // Сетка "дырок" (3x3)
            this.holes = [];
            const startX = width * 0.2;
            const startY = height * 0.3;
            const spacingX = width * 0.3;
            const spacingY = height * 0.15;

            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const hX = startX + (i * spacingX);
                    const hY = startY + (j * spacingY);
                    
                    // Рисуем дырку
                    this.add.ellipse(hX, hY + 40, 80, 40, 0x000000);
                    
                    this.holes.push({ x: hX, y: hY });
                }
            }

            // Интерфейс
            this.scoreText = this.add.text(20, 20, `ОЧКИ: 0`, { fontSize: '24px', fill: '#00f2ff', fontWeight: 'bold' });
            this.timeText = this.add.text(width - 150, 20, `ВРЕМЯ: 30`, { fontSize: '24px', fill: '#ff3300' });

            // Таймер игры
            this.gameTimer = this.time.addEvent({
                delay: 1000,
                callback: () => {
                    this.timeLeft--;
                    this.timeText.setText(`ВРЕМЯ: ${this.timeLeft}`);
                    if (this.timeLeft <= 0) this.gameOver();
                },
                loop: true
            });

            // Цикл появления айкосов
            this.spawnTimer = this.time.addEvent({
                delay: 800,
                callback: () => this.spawnIqos(),
                loop: true
            });
        }

        spawnIqos() {
            if (this.isGameOver) return;

            const hole = Phaser.Utils.Array.GetRandom(this.holes);
            
            // Создаем визуальный объект айкоса (прямоугольник с закруглением)
            const iqos = this.add.container(hole.x, hole.y + 50);
            const body = this.add.rectangle(0, 0, 40, 100, 0xffffff).setRadius(10);
            const light = this.add.circle(0, -30, 5, 0x00f2ff);
            iqos.add([body, light]);

            // Анимация выпрыгивания
            this.tweens.add({
                targets: iqos,
                y: hole.y - 20,
                duration: 300,
                yoyo: true,
                hold: 400, // Сколько он "висит" перед тем как уйти обратно
                onComplete: () => iqos.destroy()
            });

            body.setInteractive();
            body.on('pointerdown', () => {
                this.score += 10;
                this.scoreText.setText(`ОЧКИ: ${this.score}`);
                tg.HapticFeedback.impactOccurred('medium');
                
                // Эффект взрыва (разлетающиеся частицы)
                this.createExplosion(hole.x, hole.y);
                
                iqos.destroy();
            });
        }

        createExplosion(x, y) {
            for (let i = 0; i < 5; i++) {
                const part = this.add.rectangle(x, y, 10, 10, 0x00f2ff);
                this.tweens.add({
                    targets: part,
                    x: x + Phaser.Math.Between(-50, 50),
                    y: y + Phaser.Math.Between(-50, 50),
                    alpha: 0,
                    duration: 400,
                    onComplete: () => part.destroy()
                });
            }
        }

        gameOver() {
            this.isGameOver = true;
            this.spawnTimer.remove();
            this.gameTimer.remove();

            const { width, height } = this.scale;
            this.add.rectangle(width/2, height/2, width, height, 0x000000, 0.8);
            this.add.text(width/2, height/2 - 50, "КОНЕЦ ИГРЫ", { fontSize: '42px', fill: '#00f2ff' }).setOrigin(0.5);
            this.add.text(width/2, height/2 + 20, `РЕЗУЛЬТАТ: ${this.score}`, { fontSize: '28px', fill: '#fff' }).setOrigin(0.5);

            const restartBtn = this.add.rectangle(width/2, height/2 + 100, 200, 50, 0x00f2ff).setInteractive();
            this.add.text(width/2, height/2 + 100, "ЗАНОВО", { color: '#000' }).setOrigin(0.5);

            restartBtn.on('pointerdown', () => location.reload());
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        scene: WhackGame,
        backgroundColor: '#000'
    };
    new Phaser.Game(config);
</script>
</body>
</html>
